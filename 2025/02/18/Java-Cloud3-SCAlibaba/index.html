<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_apple-touch-icon-human.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_human_32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_human_16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fushiye.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism-darcula","dark":"prism-darcula"},"copy_button":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"giscus","storage":true,"lazyload":false,"nav":null,"activeClass":"giscus"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":3,"unescape":false,"preload":true}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Cloud系列主要是学习学习微服务和SpringCloud过程中记录的笔记，本文是第三篇，主要涉及SpringCloudAlibaba的组件介绍和使用方法。Spring Cloud Alibaba是阿里巴巴开源的一站式微服务解决方案，它提供了包括服务发现、配置管理、限流降级等功能，简化了构建分布式系统的复杂度。">
<meta property="og:type" content="article">
<meta property="og:title" content="Java-Cloud3-SCAlibaba">
<meta property="og:url" content="https://fushiye.github.io/2025/02/18/Java-Cloud3-SCAlibaba/index.html">
<meta property="og:site_name" content="星海拾贝">
<meta property="og:description" content="Cloud系列主要是学习学习微服务和SpringCloud过程中记录的笔记，本文是第三篇，主要涉及SpringCloudAlibaba的组件介绍和使用方法。Spring Cloud Alibaba是阿里巴巴开源的一站式微服务解决方案，它提供了包括服务发现、配置管理、限流降级等功能，简化了构建分布式系统的复杂度。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="d:\workinenglish\typora_image\image-20250303174041379.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250302193940.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303161249.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303193635.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303194135.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303221737.png">
<meta property="og:image" content="d:\workinenglish\typora_image\image-20250303222850024.png">
<meta property="og:image" content="https://github.com/alibaba/Sentinel/wiki/image/limitflow.gif">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250305214844.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250304231421.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250305221339.png">
<meta property="og:image" content="d:\workinenglish\typora_image\image-20250305222038825.png">
<meta property="og:image" content="d:\workinenglish\typora_image\image-20250305224026542.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250306004206.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250306160752.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250306215146.png">
<meta property="article:published_time" content="2025-02-18T15:20:00.000Z">
<meta property="article:modified_time" content="2025-03-12T09:10:04.599Z">
<meta property="article:author" content="Shearington">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="SpringCloudAlibaba">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:\workinenglish\typora_image\image-20250303174041379.png">


<link rel="canonical" href="https://fushiye.github.io/2025/02/18/Java-Cloud3-SCAlibaba/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://fushiye.github.io/2025/02/18/Java-Cloud3-SCAlibaba/","path":"2025/02/18/Java-Cloud3-SCAlibaba/","title":"Java-Cloud3-SCAlibaba"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java-Cloud3-SCAlibaba | 星海拾贝</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">星海拾贝</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">探索永无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">2.</span> <span class="nav-text">Nacos服务注册和配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="nav-number">2.1.1.</span> <span class="nav-text">下载安装启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Discovery%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">2.2.</span> <span class="nav-text">Discovery服务注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E6%B3%A8%E5%86%8C"><span class="nav-number">2.2.1.</span> <span class="nav-text">服务提供者注册</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E4%B8%80%E4%B8%AA%E4%BE%9D%E8%B5%96"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">导入一个依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99yaml%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">编写yaml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%BC%80%E5%90%AFNacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%94%AF%E6%8C%81"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">在主启动类开启Nacos服务注册支持</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E6%B3%A8%E5%86%8C"><span class="nav-number">2.2.2.</span> <span class="nav-text">服务消费者注册</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E4%B8%A4%E4%B8%AA%E4%BE%9D%E8%B5%96"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">导入两个依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99yaml%E6%96%87%E4%BB%B6-1"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">编写yaml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%BC%80%E5%90%AFNacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%94%AF%E6%8C%81-1"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">在主启动类开启Nacos服务注册支持</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="nav-number">2.2.2.4.</span> <span class="nav-text">服务调用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">2.2.3.</span> <span class="nav-text">负载均衡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Config%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">2.3.</span> <span class="nav-text">Config服务配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%B8%89%E4%B8%AA%E4%BE%9D%E8%B5%96"><span class="nav-number">2.3.0.1.</span> <span class="nav-text">引入三个依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99application-yaml%E5%92%8Cbootstrap-yaml"><span class="nav-number">2.3.0.2.</span> <span class="nav-text">编写application.yaml和bootstrap.yaml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8Nacos%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E3%80%82"><span class="nav-number">2.3.0.3.</span> <span class="nav-text">在Nacos服务器中添加配置。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E9%85%8D%E7%BD%AE%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="nav-number">2.3.0.4.</span> <span class="nav-text">开启配置动态刷新</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.4.</span> <span class="nav-text">数据模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DataID%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.1.</span> <span class="nav-text">DataID加载配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Group%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.2.</span> <span class="nav-text">Group加载配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NameSpace%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.3.</span> <span class="nav-text">NameSpace加载配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81"><span class="nav-number">3.</span> <span class="nav-text">Sentinel实现熔断与限流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.</span> <span class="nav-text">简介和配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">3.1.1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8C"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">下载安装运行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%84%E5%88%99"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">规则</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E7%BA%B3%E5%85%A5%E5%93%A8%E5%85%B5%E7%9B%91%E6%8E%A7"><span class="nav-number">3.1.2.</span> <span class="nav-text">服务提供者纳入哨兵监控</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96%E5%8C%85%EF%BC%9A"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">导入依赖包：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9ASentinel%E8%BF%90%E8%A1%8C%E7%AB%AF%E5%8F%A3"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">配置文件指定Sentinel运行端口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BSentinel%E7%9B%91%E6%8E%A7"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">查看Sentinel监控</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SentinelResource%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">3.2.</span> <span class="nav-text">@SentinelResource注解的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%89rest%E5%9C%B0%E5%9D%80%E9%99%90%E6%B5%81-%E9%BB%98%E8%AE%A4%E9%99%90%E6%B5%81%E8%BF%94%E5%9B%9E"><span class="nav-number">3.2.1.</span> <span class="nav-text">按rest地址限流+默认限流返回</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%89SentinelResource%E7%9A%84%E8%B5%84%E6%BA%90%E5%90%8D-value-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E8%BF%94%E5%9B%9E"><span class="nav-number">3.2.2.</span> <span class="nav-text">按SentinelResource的资源名(value)+自定义限流返回</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%89SentinelResource%E7%9A%84%E8%B5%84%E6%BA%90%E5%90%8D-value-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E8%BF%94%E5%9B%9E-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="nav-number">3.2.3.</span> <span class="nav-text">按SentinelResource的资源名(value)+自定义限流返回+服务降级处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="nav-number">3.3.</span> <span class="nav-text">流控规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.3.1.</span> <span class="nav-text">流控模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">直接模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">关联模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%93%BE%E8%B7%AF%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.3.1.3.</span> <span class="nav-text">链路模式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="nav-number">3.3.2.</span> <span class="nav-text">流控效果</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">快速失败</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WarmUp%E9%A2%84%E7%83%AD"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">WarmUp预热</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">排队等待</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="nav-number">3.4.</span> <span class="nav-text">熔断规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="nav-number">3.4.1.</span> <span class="nav-text">慢调用比例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="nav-number">3.4.2.</span> <span class="nav-text">异常比例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="nav-number">3.4.3.</span> <span class="nav-text">异常数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="nav-number">3.5.</span> <span class="nav-text">热点规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9%EF%BC%88%E7%89%B9%E5%AE%9A%E5%8F%82%E6%95%B0%E5%80%BC%E9%99%90%E6%B5%81%E8%B1%81%E5%85%8D%EF%BC%89"><span class="nav-number">3.5.1.</span> <span class="nav-text">参数例外项（特定参数值限流豁免）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="nav-number">3.6.</span> <span class="nav-text">授权规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">3.7.</span> <span class="nav-text">规则持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="nav-number">3.7.1.</span> <span class="nav-text">添加依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.7.2.</span> <span class="nav-text">编写配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0Nacos%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="nav-number">3.7.3.</span> <span class="nav-text">添加Nacos配置规则</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%EF%BC%88Flow-Rule%EF%BC%89"><span class="nav-number">3.7.3.1.</span> <span class="nav-text">1. 流控规则（Flow Rule）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99%EF%BC%88Degrade-Rule%EF%BC%89"><span class="nav-number">3.7.3.2.</span> <span class="nav-text">2. 熔断规则（Degrade Rule）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E8%A7%84%E5%88%99%EF%BC%88Param-Flow-Rule%EF%BC%89"><span class="nav-number">3.7.3.3.</span> <span class="nav-text">3. 热点参数规则（Param Flow Rule）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%EF%BC%88Authority-Rule%EF%BC%89"><span class="nav-number">3.7.3.4.</span> <span class="nav-text">4. 授权规则（Authority Rule）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99%EF%BC%88System-Rule%EF%BC%89"><span class="nav-number">3.7.3.5.</span> <span class="nav-text">5. 系统规则（System Rule）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenFeign%E6%95%B4%E5%90%88%E5%AE%9E%E7%8E%B0fallback%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="nav-number">3.8.</span> <span class="nav-text">OpenFeign整合实现fallback服务降级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E6%A8%A1%E5%9D%97%E5%BC%95%E5%85%A5sentinel%E5%B9%B6%E5%BC%80%E5%90%AF%E6%94%AF%E6%8C%81"><span class="nav-number">3.8.1.</span> <span class="nav-text">在服务提供者模块引入sentinel并开启支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API%E5%B7%A5%E5%85%B7%E6%A8%A1%E5%9D%97%E5%BC%95%E5%85%A5sentinel%E5%B9%B6%E7%BB%9F%E4%B8%80%E6%8C%87%E5%AE%9A%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="nav-number">3.8.2.</span> <span class="nav-text">API工具模块引入sentinel并统一指定服务降级处理方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E8%80%85%E5%BC%95%E5%85%A5sentinel%E5%B9%B6%E6%BF%80%E6%B4%BBSentinel%E5%AF%B9Feign%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-number">3.8.3.</span> <span class="nav-text">服务调用者引入sentinel并激活Sentinel对Feign的支持</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway%E6%95%B4%E5%90%88%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="nav-number">3.9.</span> <span class="nav-text">Gateway整合实现服务限流</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">Seata处理分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="nav-number">4.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="nav-number">4.1.1.</span> <span class="nav-text">下载安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8Seata%E6%9C%8D%E5%8A%A1%EF%BC%88DB%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="nav-number">4.1.2.</span> <span class="nav-text">启动Seata服务（DB模式）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9AMySQL%E6%96%B0%E5%BB%BAseata%E5%BA%93%EF%BC%8C%E5%9C%A8%E5%85%B6%E4%B8%AD%E5%BB%BA%E8%A1%A8global-table%E3%80%81branch-table%E3%80%81lock-table"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">步骤1：MySQL新建seata库，在其中建表global_table、branch_table、lock_table</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">步骤2：修改配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%90%E8%A1%8C%E5%B9%B6%E9%AA%8C%E8%AF%81"><span class="nav-number">4.1.2.3.</span> <span class="nav-text">启动运行并验证</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">4.2.</span> <span class="nav-text">工作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AT%E6%A8%A1%E5%BC%8F%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.2.1.</span> <span class="nav-text">AT模式工作流程示例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1%E5%BC%80%E5%90%AF%EF%BC%88TM-%E5%8F%91%E8%B5%B7%EF%BC%89"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">1. 全局事务开启（TM 发起）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%88%86%E6%94%AF%E4%BA%8B%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%89%A7%E8%A1%8C%EF%BC%88RM-%E5%8F%82%E4%B8%8E%EF%BC%89"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">2. 分支事务注册与执行（RM 参与）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4-%E5%9B%9E%E6%BB%9A%EF%BC%88TC-%E5%8D%8F%E8%B0%83%EF%BC%89"><span class="nav-number">4.2.1.3.</span> <span class="nav-text">3. 全局事务提交&#x2F;回滚（TC 协调）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%9C%BA%E6%99%AF%E5%A4%84%E7%90%86"><span class="nav-number">4.2.1.4.</span> <span class="nav-text">异常场景处理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="nav-number">4.3.</span> <span class="nav-text">项目实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%85%E8%A6%81%E6%AD%A5%E9%AA%A4"><span class="nav-number">4.3.1.</span> <span class="nav-text">必要步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%9B%E5%BB%BA"><span class="nav-number">4.3.2.</span> <span class="nav-text">微服务创建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">引入依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.2.2.</span> <span class="nav-text">编写配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E5%89%8D%E4%BD%BF%E7%94%A8GlobalTransactional%E6%B3%A8%E8%A7%A3"><span class="nav-number">4.3.2.3.</span> <span class="nav-text">数据库操作前使用GlobalTransactional注解</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">4.4.</span> <span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AT-%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%88%E4%B8%A4%E9%98%B6%E6%AE%B5%EF%BC%89"><span class="nav-number">4.4.1.</span> <span class="nav-text">AT 模式的工作流程（两阶段）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%88Phase-1%EF%BC%89%EF%BC%9A%E6%89%A7%E8%A1%8C%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E5%B9%B6%E7%94%9F%E6%88%90-undo-log"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">1. 第一阶段（Phase 1）：执行本地事务并生成 undo_log</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%88Phase-2%EF%BC%89%EF%BC%9A%E5%85%A8%E5%B1%80%E6%8F%90%E4%BA%A4%E6%88%96%E5%9B%9E%E6%BB%9A"><span class="nav-number">4.4.1.2.</span> <span class="nav-text">2. 第二阶段（Phase 2）：全局提交或回滚</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AT-%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6"><span class="nav-number">4.4.2.</span> <span class="nav-text">AT 模式的核心机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-undo-log-%E6%9C%BA%E5%88%B6"><span class="nav-number">4.4.2.1.</span> <span class="nav-text">1. undo_log 机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%85%A8%E5%B1%80%E9%94%81%E6%9C%BA%E5%88%B6"><span class="nav-number">4.4.2.2.</span> <span class="nav-text">2. 全局锁机制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AT-%E6%A8%A1%E5%BC%8F-vs-%E4%BC%A0%E7%BB%9F-2PC"><span class="nav-number">4.4.3.</span> <span class="nav-text">AT 模式 vs 传统 2PC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AT-%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B8%E5%9E%8B%E9%97%AE%E9%A2%98"><span class="nav-number">4.4.4.</span> <span class="nav-text">AT 模式的典型问题</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Shearington"
      src="/images/head.jpg">
  <p class="site-author-name" itemprop="name">Shearington</p>
  <div class="site-description" itemprop="description">诗酒趁年华</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Fushiye/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Fushiye&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shearington@foxmail.com" title="E-Mail → mailto:shearington@foxmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fushiye.github.io/2025/02/18/Java-Cloud3-SCAlibaba/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpg">
      <meta itemprop="name" content="Shearington">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="星海拾贝">
      <meta itemprop="description" content="诗酒趁年华">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java-Cloud3-SCAlibaba | 星海拾贝">
      <meta itemprop="description" content="Cloud系列主要是学习学习微服务和SpringCloud过程中记录的笔记，本文是第三篇，主要涉及SpringCloudAlibaba的组件介绍和使用方法。Spring Cloud Alibaba是阿里巴巴开源的一站式微服务解决方案，它提供了包括服务发现、配置管理、限流降级等功能，简化了构建分布式系统的复杂度。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java-Cloud3-SCAlibaba
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-02-18 23:20:00" itemprop="dateCreated datePublished" datetime="2025-02-18T23:20:00+08:00">2025-02-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-12 17:10:04" itemprop="dateModified" datetime="2025-03-12T17:10:04+08:00">2025-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">框架与工具</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>34 分钟</span>
    </span>
</div>

            <div class="post-description">Cloud系列主要是学习学习微服务和SpringCloud过程中记录的笔记，本文是第三篇，主要涉及SpringCloudAlibaba的组件介绍和使用方法。Spring Cloud Alibaba是阿里巴巴开源的一站式微服务解决方案，它提供了包括服务发现、配置管理、限流降级等功能，简化了构建分布式系统的复杂度。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><img src="D:\workinenglish\typora_image\image-20250303174041379.png" alt="image-20250303174041379"></p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-alibaba#overview">SpringCloud官网</a> 	<a target="_blank" rel="noopener" href="https://sca.aliyun.com/">Alibaba官网</a>	<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba">源码</a>	<a target="_blank" rel="noopener" href="https://sca.aliyun.com/docs/2022/overview/version-explain/?spm=5176.29160081.0.0.539034bfR0R5Av">文档</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/2023.x/README-zh.md">介绍</a></p>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250302193940.png"></p>
<h2 id="Nacos服务注册和配置中心"><a href="#Nacos服务注册和配置中心" class="headerlink" title="Nacos服务注册和配置中心"></a>Nacos服务注册和配置中心</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><a target="_blank" rel="noopener" href="https://nacos.io/">Nacos官网</a>  	<a target="_blank" rel="noopener" href="https://nacos.io/docs/v2/what-is-nacos/?spm=5238cd80.2ef5001f.0.0.3f613b7co1mDDd">文档</a></p>
<p><strong>Nacos</strong> 是阿里巴巴开源的一个用于动态服务发现、配置管理和服务管理的平台，全称是 <strong>Dynamic Naming and Configuration Service</strong>。它旨在帮助开发者更轻松地构建云原生应用，尤其适用于微服务架构。</p>
<p><strong>核心功能</strong></p>
<ol>
<li><p><strong>服务发现</strong>：<br>支持动态注册和发现服务实例，客户端可以通过 Nacos 获取可用的服务地址列表。适用于微服务之间的调用场景。</p>
</li>
<li><p><strong>配置管理</strong>：<br>提供集中化的配置管理能力，支持动态更新配置而无需重启应用，降低运维成本。适用于需要统一管理配置的应用场景。</p>
</li>
<li><p><strong>服务管理</strong>：<br>提供服务的健康检查、流量管理、权重设置等功能，帮助优化服务质量和性能。</p>
</li>
</ol>
<h4 id="下载安装启动"><a href="#下载安装启动" class="headerlink" title="下载安装启动"></a>下载安装启动</h4><p>本文使用<code>Nacos2.2.3</code>，<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases/download/2.2.3/nacos-server-2.2.3.zip?spm=5238cd80.2ef5001f.0.0.3f613b7cNchNz3&file=nacos-server-2.2.3.zip">下载</a>，在解压后文件夹的bin目录下使用如下命令单机运行：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\startup.<span class="built_in">cmd</span> -m standalone</span><br></pre></td></tr></table></figure>

<p>访问<code>http://localhost:8848/nacos/</code>验证安装结果。默认账号密码均为nacos</p>
<h3 id="Discovery服务注册中心"><a href="#Discovery服务注册中心" class="headerlink" title="Discovery服务注册中心"></a>Discovery服务注册中心</h3><h4 id="服务提供者注册"><a href="#服务提供者注册" class="headerlink" title="服务提供者注册"></a>服务提供者注册</h4><h5 id="导入一个依赖"><a href="#导入一个依赖" class="headerlink" title="导入一个依赖"></a>导入一个依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="编写yaml文件"><a href="#编写yaml文件" class="headerlink" title="编写yaml文件"></a>编写yaml文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span> <span class="comment"># Nacos中服务将以此名注册</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># 配置Nacos地址</span></span><br></pre></td></tr></table></figure>

<h5 id="在主启动类开启Nacos服务注册支持"><a href="#在主启动类开启Nacos服务注册支持" class="headerlink" title="在主启动类开启Nacos服务注册支持"></a>在主启动类开启Nacos服务注册支持</h5><p>和consul一样，使用注解<code>@EnableDiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main9001</span></span><br><span class="line">&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务，在<code>http://localhost:8848/nacos/</code>网址，服务管理-服务列表中即可看到服务注册成功</p>
<h4 id="服务消费者注册"><a href="#服务消费者注册" class="headerlink" title="服务消费者注册"></a>服务消费者注册</h4><h5 id="导入两个依赖"><a href="#导入两个依赖" class="headerlink" title="导入两个依赖"></a>导入两个依赖</h5><p>需要额外导入负载均衡依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--loadbalancer--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="编写yaml文件-1"><a href="#编写yaml文件-1" class="headerlink" title="编写yaml文件"></a>编写yaml文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="comment">#消费者将要去访问的微服务名称(nacos微服务提供者叫什么你写什么)</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>

<h5 id="在主启动类开启Nacos服务注册支持-1"><a href="#在主启动类开启Nacos服务注册支持-1" class="headerlink" title="在主启动类开启Nacos服务注册支持"></a>在主启动类开启Nacos服务注册支持</h5><p>和consul一样，使用注解<code>@EnableDiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main9001</span></span><br><span class="line">&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务，在<code>http://localhost:8848/nacos/</code>网址，服务管理-服务列表中即可看到服务注册成功</p>
<h5 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h5><p>类似consul的学习过程，现在先使用RestTemplate实现服务调用，编写配置文件如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span> <span class="comment">//赋予RestTemplate负载均衡的能力</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务调用如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/pay/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(serverURL + <span class="string">&quot;/pay/nacos/&quot;</span> + id, String.class);</span><br><span class="line">        <span class="keyword">return</span> result + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;    我是OrderNacosController83调用者。。。。。。&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>为进行负载均衡演示，需要两个服务提供者，在IDEA中可以快速克隆服务：下边栏-服务，右键需要克隆的服务，复制配置：注意，VM选项中需要说明新服务运行端口<code>-DServer.port=</code></p>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303161249.png"></p>
<p>应用即可。</p>
<p>上述配置中，在服务消费者注册时，RestTemplate中已经使用<code>@LoadBalanced</code>注解开启负载均衡配置，因此无需其他操作，访问服务消费者模块对应网页即可见其实现了负载均衡</p>
<h3 id="Config服务配置中心"><a href="#Config服务配置中心" class="headerlink" title="Config服务配置中心"></a>Config服务配置中心</h3><p>Nacos可以实现类似Consul一样的配置管理，本节相当于[cloud2-consul服务注册与发现-分布式配置]章节</p>
<p>微服务意味着要将单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务。由于每个服务都需要必要的配置信息才能运行，所以一套集中式的、动态的配置管理设施是必不可少的。比如某些配置文件中的内容大部分都是相同的，只有个别的配置项不同。就拿数据库配置来说吧，如果每个微服务使用的技术栈都是相同的，则每个微服务中关于数据库的配置几乎都是相同的，有时候主机迁移了，我希望<strong>一次修改，处处生效</strong>。</p>
<h5 id="引入三个依赖"><a href="#引入三个依赖" class="headerlink" title="引入三个依赖"></a><strong>引入三个依赖</strong></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--bootstrap--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--nacos-config--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="编写application-yaml和bootstrap-yaml"><a href="#编写application-yaml和bootstrap-yaml" class="headerlink" title="编写application.yaml和bootstrap.yaml"></a>编写application.yaml和bootstrap.yaml</h5><p>类似模块[cloud-provider-payment8001]</p>
<p><strong>bootstrap.yaml：</strong>与nacos和服务器相关的是配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nacos配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># Nacos作为配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 指定yaml格式的配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nacos端配置文件DataId的命名规则是：</span></span><br><span class="line"><span class="comment"># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br><span class="line"><span class="comment"># 本案例的DataID是:nacos-config-client-dev.yaml</span></span><br></pre></td></tr></table></figure>

<p><strong>application.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 表示开发环境</span></span><br><span class="line">    <span class="comment">#active: prod # 表示生产环境</span></span><br><span class="line">    <span class="comment">#active: test # 表示测试环境</span></span><br></pre></td></tr></table></figure>



<h5 id="在Nacos服务器中添加配置。"><a href="#在Nacos服务器中添加配置。" class="headerlink" title="在Nacos服务器中添加配置。"></a>在Nacos服务器中添加配置。</h5><p>在nacos中添加配置必须严格按照规定的格式：</p>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303193635.png"></p>
<p>填写方式如下</p>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303194135.png"></p>
<h5 id="开启配置动态刷新"><a href="#开启配置动态刷新" class="headerlink" title="开启配置动态刷新"></a>开启配置动态刷新</h5><p>在controller类前添加注解<code>@RefreshScope</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 在控制器类加入@RefreshScope注解使当前类下的配置支持Nacos的动态刷新功能。</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br></pre></td></tr></table></figure>





<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250303221737.png"></p>
<table>
<thead>
<tr>
<th>1 是什么</th>
<th>类似Java里面的package名和类名，最外层的Namespace是可以用于区分部署环境的，Group和DataID逻辑上区分两个目标对象</th>
</tr>
</thead>
<tbody><tr>
<td>2 默认值</td>
<td>默认情况：Namespace&#x3D;public，Group&#x3D;DEFAULT_GROUPNacos默认的命名空间是public，Namespace主要用来实现隔离。比方说我们现在有三个环境：开发、测试、生产环境，我们就可以创建三个Namespace，不同的Namespace之间是隔离的。Group默认是DEFAULT_GROUP，Group可以把不同的微服务划分到同一个分组里面去</td>
</tr>
<tr>
<td>Service就是微服务</td>
<td>一个Service可以包含一个或者多个Cluster（集群），Nacos默认Cluster是DEFAULT，Cluster是对指定微服务的一个虚拟划分。见下一节：服务领域模型-补充说明</td>
</tr>
</tbody></table>
<p><img src="D:\workinenglish\typora_image\image-20250303222850024.png" alt="image-20250303222850024"></p>
<h4 id="DataID加载配置"><a href="#DataID加载配置" class="headerlink" title="DataID加载配置"></a>DataID加载配置</h4><p>通过指定spring.profile.active和配置文件的DataId来使不同环境读取不同配置</p>
<p>上述即为按照DataID加载不同配置的情况，所有的配置都在默认命名空间的默认组DEFAULT_GROUP里面</p>
<h4 id="Group加载配置"><a href="#Group加载配置" class="headerlink" title="Group加载配置"></a>Group加载配置</h4><p>在Nacos控制网页新建配置时，在Group栏输入同样的字符即代表在同一组，</p>
<p><strong>yaml配置文件修改如下：</strong></p>
<p><code>bootstrap.yaml</code>: 在<code>config</code>下新增一条<code>group</code>的配置即可</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos作为配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">GROUP_NAME</span>  <span class="comment"># 这里</span></span><br></pre></td></tr></table></figure>



<h4 id="NameSpace加载配置"><a href="#NameSpace加载配置" class="headerlink" title="NameSpace加载配置"></a>NameSpace加载配置</h4><p>在Nacos控制网页-命名空间，新建命名空间，然后在新建配置时选择同一个命名空间的配置在同一命名空间。</p>
<p><strong>yaml配置文件修改如下：</strong></p>
<p><code>bootstrap.yaml</code>: 在<code>config</code>下新增一条<code>namespace</code>的配置即可</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nacos配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos作为配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">NAMESPACE_NAME</span></span><br></pre></td></tr></table></figure>







<h2 id="Sentinel实现熔断与限流"><a href="#Sentinel实现熔断与限流" class="headerlink" title="Sentinel实现熔断与限流"></a>Sentinel实现熔断与限流</h2><h3 id="简介和配置"><a href="#简介和配置" class="headerlink" title="简介和配置"></a>简介和配置</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p><a target="_blank" rel="noopener" href="http://sentinelguard.io/zh-cn/">官网</a>   <a target="_blank" rel="noopener" href="https://github.com/alibaba/sentinel/wiki/%E4%B8%BB%E9%A1%B5">中文介绍</a></p>
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。<a target="_blank" rel="noopener" href="https://sentinelguard.io/">Sentinel</a> 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。</p>
<p><strong>思想：</strong></p>
<p>流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状，如下图所示：</p>
<p><img src="https://github.com/alibaba/Sentinel/wiki/image/limitflow.gif" alt="img"></p>
<h5 id="下载安装运行"><a href="#下载安装运行" class="headerlink" title="下载安装运行"></a>下载安装运行</h5><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/sentinel/releases">github下载</a>  <code>java -jar java -jar sentinel-dashboard-1.8.8.jar</code>运行，在</p>
<p><code>http://localhost:8080</code>查看，默认用户名密码均为sentinel</p>
<h5 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h5><ul>
<li><strong>流控规则</strong>（Flow Rule）主要用于限制资源的访问频率。</li>
<li><strong>熔断规则</strong>（Degrade Rule）用于在服务出现异常时自动触发降级策略。</li>
<li><strong>热点参数规则</strong>（Param Flow Rule）用于对特定参数进行限流。</li>
<li><strong>授权规则</strong>（Authority Rule）用于基于应用名称进行访问控制。</li>
<li><strong>系统规则</strong>（System Rule）用于监控系统的整体健康状况，如 CPU 使用率、系统负载等。</li>
</ul>
<h4 id="服务提供者纳入哨兵监控"><a href="#服务提供者纳入哨兵监控" class="headerlink" title="服务提供者纳入哨兵监控"></a>服务提供者纳入哨兵监控</h4><h5 id="导入依赖包："><a href="#导入依赖包：" class="headerlink" title="导入依赖包："></a>导入依赖包：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud alibaba sentinel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置文件指定Sentinel运行端口"><a href="#配置文件指定Sentinel运行端口" class="headerlink" title="配置文件指定Sentinel运行端口"></a>配置文件指定Sentinel运行端口</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">transport:</span></span><br><span class="line">      <span class="comment"># 配置Sentinel dashboard控制台服务地址</span></span><br><span class="line">      <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> </span><br><span class="line">      <span class="comment"># Sentinel 客户端与 Sentinel 控制台通信时使用的端口，默认8719</span></span><br><span class="line">      <span class="comment"># 假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8719</span> </span><br></pre></td></tr></table></figure>

<p><code>port: 8719</code> 是客户端用于与该控制台 gRPC 通信的本地端口， Sentinel 客户端通过此端口将流量数据、规则配置等信息上报给 Sentinel 控制台，从而实现对服务的实时监控和动态规则调整。</p>
<h5 id="查看Sentinel监控"><a href="#查看Sentinel监控" class="headerlink" title="查看Sentinel监控"></a>查看Sentinel监控</h5><p>Sentinel采取的是懒加载监控方式，必须先访问接口才能开始监控，因此需要先访问接口再查看监控情况</p>
<h3 id="SentinelResource注解的使用"><a href="#SentinelResource注解的使用" class="headerlink" title="@SentinelResource注解的使用"></a>@SentinelResource注解的使用</h3><p><code>@SentinelResource</code> 是 Spring Cloud Alibaba Sentinel 提供的一个注解，用于定义资源并配置流量控制、熔断降级等规则。通过该注解，可以方便地对方法进行限流和降级处理。</p>
<p><strong>参数说明</strong></p>
<ul>
<li><strong>value</strong>：资源名称，用于标识被保护的资源。</li>
<li><strong>blockHandler</strong>：指定一个处理限流或降级的函数，必须是同类中的方法，且参数列表需包含 <code>BlockException</code> 类型的参数。</li>
<li><strong>fallback</strong>：指定一个回退方法，用于处理业务异常或其他异常，方法签名应与原方法一致，但最后一个参数为 <code>Throwable</code> 类型。</li>
<li><strong>defaultFallback</strong>：全局默认的回退方法，适用于多个资源共用一个回退逻辑的情况。</li>
</ul>
<h4 id="按rest地址限流-默认限流返回"><a href="#按rest地址限流-默认限流返回" class="headerlink" title="按rest地址限流+默认限流返回"></a>按rest地址限流+默认限流返回</h4><p>此时不需要<code>@SentinelResource</code>注解也可以实现，因为rest地址（即<code>@GetMapping()</code>）本就唯一，不可重复。默认情况下限流开始时返回<code>Blocked by Sentinel (flow limiting)</code>。</p>
<h4 id="按SentinelResource的资源名-value-自定义限流返回"><a href="#按SentinelResource的资源名-value-自定义限流返回" class="headerlink" title="按SentinelResource的资源名(value)+自定义限流返回"></a>按SentinelResource的资源名(value)+自定义限流返回</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/limit/resource&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;byResource&quot;,blockHandler = &quot;blockHandlerFunction&quot;)</span></span><br><span class="line"><span class="comment">// blockHandler的值即自定义限流返回方法名</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">bySource</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;按资源名限流并使用自定义限流返回&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">blockHandlerFunction</span><span class="params">(BlockException blockException)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;服务不可用，限流中&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置：</p>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250305214844.png"></p>
<h4 id="按SentinelResource的资源名-value-自定义限流返回-服务降级处理"><a href="#按SentinelResource的资源名-value-自定义限流返回-服务降级处理" class="headerlink" title="按SentinelResource的资源名(value)+自定义限流返回+服务降级处理"></a>按SentinelResource的资源名(value)+自定义限流返回+服务降级处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/limit/doAction/&#123;p1&#125;&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;doActionSentinelResource&quot;,</span></span><br><span class="line"><span class="meta">        blockHandler = &quot;doActionBlockHandler&quot;, fallback = &quot;doActionFallback&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">doAction</span><span class="params">(<span class="meta">@PathVariable(&quot;p1&quot;)</span> Integer p1)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (p1 == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;p1等于零直接异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;doAction&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">doActionBlockHandler</span><span class="params">(<span class="meta">@PathVariable(&quot;p1&quot;)</span> Integer p1, BlockException e)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;sentinel配置自定义限流了&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">doActionFallback</span><span class="params">(<span class="meta">@PathVariable(&quot;p1&quot;)</span> Integer p1,Throwable e)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;程序逻辑异常了&quot;</span>+<span class="string">&quot;\t&quot;</span>+e.getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>blockHandler</code> 和<code>fallback</code>的区别</p>
<ul>
<li><p><strong>blockHandler</strong>：该属性指向的方法会在请求被 Sentinel 限流或者降级时触发执行。简单来说，当请求超过了预设的阈值（如QPS过高），或者某些规则（如熔断规则）触发导致请求被拒绝时，会执行此方法。</p>
</li>
<li><p><strong>fallback</strong>：这个属性对应的方法会在调用过程中发生异常（比如空指针异常、除零错误等业务异常）或 Sentinel 规则（如流量控制、服务熔断）生效时触发执行。但是，与 <code>blockHandler</code> 不同的是，它更倾向于捕捉和处理业务逻辑中的异常，为用户提供一个友好的响应或备用方案。</p>
</li>
</ul>
<p><strong>何时执行：</strong></p>
<ul>
<li>当因流量控制或服务熔断等原因被 Sentinel 拒绝时，会执行 <code>blockHandler</code> 所指定的方法。</li>
<li>而当出现业务逻辑异常或任何未预料的运行时异常时，则会执行 <code>fallback</code> 方法。</li>
</ul>
<h3 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h3><h4 id="流控模式"><a href="#流控模式" class="headerlink" title="流控模式"></a>流控模式</h4><p>在Sentinel控制态可以新增流控规则，可以有三种流控模式：直接、关联、链路</p>
<h5 id="直接模式"><a href="#直接模式" class="headerlink" title="直接模式"></a>直接模式</h5><p>默认的流控模式，当接口达到限流条件时，直接开启限流功能。</p>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250304231421.png"></p>
<h5 id="关联模式"><a href="#关联模式" class="headerlink" title="关联模式"></a>关联模式</h5><p>当关联的资源达到阈值时，限流自己&#x3D;》A病B吃药</p>
<p>只需要选择关联模式并输入关联资源URL即可</p>
<h5 id="链路模式"><a href="#链路模式" class="headerlink" title="链路模式"></a>链路模式</h5><p>当来自不同链路的请求对同一目标访问时，实施针对性的不同限流措施。即来自某些链路的请求就限流，某些就不限流</p>
<p><strong>步骤1：</strong>修改yaml配置，添加<code>transport</code>同级配置。非必要，视情况决定</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">web-context-unify:</span> <span class="literal">false</span> <span class="comment"># controller层的方法对service层调用不认为是同一个根链路</span></span><br></pre></td></tr></table></figure>

<p><strong>演示步骤1：</strong>创建service层方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlowLimitService</span> &#123;</span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;common&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">common</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------FlowLimitService come in&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>演示步骤2：</strong>Controller层调用service层方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> FlowLimitService flowLimitService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testC&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testC</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    flowLimitService.common();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------testC&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤2</strong>：在控制台新增链路模式流控规则，资源名填写<code>@SentinelResource</code>的<code>value</code>属性值， 入口资源填写其来自的链路URL(\testC)。</p>
<h4 id="流控效果"><a href="#流控效果" class="headerlink" title="流控效果"></a>流控效果</h4><h5 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h5><p>请求直接失败并抛出异常，默认结果</p>
<h5 id="WarmUp预热"><a href="#WarmUp预热" class="headerlink" title="WarmUp预热"></a>WarmUp预热</h5><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8">官网</a></p>
<p>当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过”冷启动”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。</p>
<p>选择warmup流程效果，设置预热时长，默认情况下，流量上限从阈值的三分之一开始，经预热时长后升到阈值上限为止。</p>
<h5 id="排队等待"><a href="#排队等待" class="headerlink" title="排队等待"></a>排队等待</h5><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6-%E5%8C%80%E9%80%9F%E6%8E%92%E9%98%9F%E6%A8%A1%E5%BC%8F">官网</a></p>
<p>控制请求匀速访问，以固定的间隔时间让请求通过。当请求到来的时候：</p>
<ul>
<li>如果当前请求距离上个通过的请求通过的时间间隔不小于预设值，则让当前请求通过；</li>
<li>否则，计算当前请求的预期通过时间，<ul>
<li>如果该请求的预期通过时间小于规则预设的 timeout 时间，则该请求会等待直到预设时间到来通过（排队等待处理）；</li>
<li>若预期的通过时间超出最大排队时长，则直接拒接这个请求。</li>
</ul>
</li>
</ul>
<h3 id="熔断规则"><a href="#熔断规则" class="headerlink" title="熔断规则"></a>熔断规则</h3><p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/circuit-breaking.html">官网</a></p>
<p>采取的熔断策略和CircuitBreaker一致：</p>
<h4 id="慢调用比例"><a href="#慢调用比例" class="headerlink" title="慢调用比例"></a>慢调用比例</h4><p>当业务逻辑的处理时间超过最大RT时，将其判定为慢调用。在统计时长内，慢调用的比例高于比例阈值，且实际请求数目大于设定的最小请求数时，触发熔断。</p>
<p>慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</p>
<h4 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h4><p>异常比例 (<code>ERROR_RATIO</code>)：当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</p>
<p>注意异常降级<strong>仅针对业务异常</strong>，对 Sentinel 限流降级本身的异常（<code>BlockException</code>）不生效。为了统计异常比例或异常数，需要通过 <code>Tracer.trace(ex)</code> 记录业务异常。</p>
<h4 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h4><p>异常数 (<code>ERROR_COUNT</code>)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</p>
<h3 id="热点规则"><a href="#热点规则" class="headerlink" title="热点规则"></a>热点规则</h3><p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html">官方文档</a></p>
<p>热点即经常访问的数据，很多时候我们希望统计或者限制某个热点数据中访问频次最高的TopN数据，并对其访问进行限流或者其它操作。</p>
<p>针对热点参数的限流操作：</p>
<ul>
<li><p>如果请求参数<strong>包含</strong>被限流的参数（下文为p1），且满足限流条件，则开始限流，如：</p>
<p>  <code>http://localhost:8401/testHotKey?p2=1&amp;p1=1</code>或<code>http://localhost:8401/testHotKey?p1=1</code></p>
</li>
<li><p>如果请求参数<strong>不包含</strong>被限流的参数（下文为p1），即使满足限流条件也不会限流，如：</p>
<p>  <code>http://localhost:8401/testHotKey?p2=1</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testHotKey&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testHotKey&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testHotKey</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;,required = false)</span> String p1, </span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(value = &quot;p2&quot;,required = false)</span> String p2)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------testHotKey&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250305221339.png"></p>
<h4 id="参数例外项（特定参数值限流豁免）"><a href="#参数例外项（特定参数值限流豁免）" class="headerlink" title="参数例外项（特定参数值限流豁免）"></a>参数例外项（特定参数值限流豁免）</h4><p>在高级选项中可以设置参数例外项，即当P1参数的参数值为2时，即使每秒请求达到1次，但只要没有达到100次都不会限流，如果达到200次会限流。<strong>注意，填写完规则后一定要点击添加按钮才会添加！！</strong></p>
<p><img src="D:\workinenglish\typora_image\image-20250305222038825.png" alt="image-20250305222038825"></p>
<h3 id="授权规则"><a href="#授权规则" class="headerlink" title="授权规则"></a>授权规则</h3><p>很多时候，我们需要根据调用方来限制资源是否通过，这时候可以使用 Sentinel 的黑白名单控制的功能。黑白名单根据资源的请求来源（<code>origin</code>）限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求通过。</p>
<p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/origin-authority-control.html">官方文档</a></p>
<p><strong>配置：</strong></p>
<p><strong>步骤1：</strong>实现  接口并重写 方法，说明如何判定请求来源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRequestOriginParser</span> <span class="keyword">implements</span> <span class="title class_">RequestOriginParser</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">parseOrigin</span><span class="params">(HttpServletRequest httpServletRequest)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据请求参数serverName判断请求来源，在实际生产中可以通过getCookies()等来区分不同请求来源</span></span><br><span class="line">        <span class="keyword">return</span> httpServletRequest.getParameter(<span class="string">&quot;serverName&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:\workinenglish\typora_image\image-20250305224026542.png" alt="image-20250305224026542"></p>
<p>仅有<code>http://localhost:8401/empower?serverName=a</code>和<code>http://localhost:8401/empower?serverName=b</code>可以访问，其他均被限流</p>
<p>可以对不同的接口采取不同的优先检查：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">parseOrigin</span><span class="params">(HttpServletRequest httpServletRequest)</span> &#123;</span><br><span class="line">       <span class="comment">// 获取请求的资源名称或其他标识符</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> httpServletRequest.getRequestURI();</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 假设某些接口路径需要优先检查cookie</span></span><br><span class="line">       <span class="keyword">if</span> (resource.startsWith(<span class="string">&quot;/api/cookie-priority&quot;</span>)) &#123;</span><br><span class="line">           <span class="keyword">return</span> checkCookiePriority(httpServletRequest);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 其他接口优先检查serverName</span></span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> checkServerNamePriority(httpServletRequest);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>





<h3 id="规则持久化"><a href="#规则持久化" class="headerlink" title="规则持久化"></a>规则持久化</h3><p>将 Sentinel 限流配置规则持久化到 Nacos 保存后，只要刷新访问URL，Sentinel就能自动扫描到Nacos中保存的配置，可以确保在应用重启后，流量控制、熔断降级等规则不会丢失。Nacos 作为配置中心，能够动态管理这些规则，并且支持实时更新。</p>
<h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>主要是<code>sentinel-datasource-nacos</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--SpringCloud alibaba sentinel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">datasource:</span>	</span><br><span class="line">        <span class="attr">ds1:</span>								    <span class="comment"># 规则名，自定义		</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">localhost:8848</span>			<span class="comment"># Nacos 运行地址端口</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">$&#123;spring.application.name&#125;</span>  <span class="comment"># Nacos 添加配置的 DataId</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span>				<span class="comment"># Nacos 添加配置的 GroupId</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span>						<span class="comment"># 配置格式</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span> 					<span class="comment"># Sentinel的规则类型：流控、熔断、热点、授权、系统保护</span></span><br></pre></td></tr></table></figure>

<p><code>rule-type</code>：可在<code>com.alibaba.cloud.sentinel.datasource.RuleType</code>查看源码。</p>
<ul>
<li><code>FLOW</code>：流量控制规则</li>
<li><code>DEGRADE</code>：熔断降级规则</li>
<li><code>PARAM_FLOW</code>：热点规则</li>
<li><code>SYSTEM</code>：系统保护规则</li>
<li><code>AUTHORITY</code>：访问控制规则（授权规则）</li>
</ul>
<h4 id="添加Nacos配置规则"><a href="#添加Nacos配置规则" class="headerlink" title="添加Nacos配置规则"></a>添加Nacos配置规则</h4><p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250306004206.png"></p>
<h5 id="1-流控规则（Flow-Rule）"><a href="#1-流控规则（Flow-Rule）" class="headerlink" title="1. 流控规则（Flow Rule）"></a>1. 流控规则（Flow Rule）</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/rateLimit/byUrl&quot;</span><span class="punctuation">,</span>		<span class="comment">// 资源名称</span></span><br><span class="line">        <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span>				<span class="comment">// 来源应用</span></span><br><span class="line">        <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>							<span class="comment">// 阈值类型，0为线程数，1为QPS（异常比例）</span></span><br><span class="line">        <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>							<span class="comment">// 单机阈值</span></span><br><span class="line">        <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span>						<span class="comment">// 流控模式：0为直接，1为关联，2为链路</span></span><br><span class="line">        <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span>				<span class="comment">// 流控效果：0为快速失败，1为WarmUP，2为排队等待</span></span><br><span class="line">        <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>				<span class="comment">// 是否集群</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h5 id="2-熔断规则（Degrade-Rule）"><a href="#2-熔断规则（Degrade-Rule）" class="headerlink" title="2. 熔断规则（Degrade Rule）"></a>2. 熔断规则（Degrade Rule）</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yourResourceName&quot;</span><span class="punctuation">,</span> <span class="comment">// 资源名称，通常是你要保护的接口或方法的名字。</span></span><br><span class="line">    <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span> <span class="comment">// 阈值，具体含义依赖于 grade 的值：</span></span><br><span class="line">                 <span class="comment">// - 当 grade 为 1 时，表示错误比例（百分比）；</span></span><br><span class="line">                 <span class="comment">// - 当 grade 为 0 时，表示慢调用比例阈值。</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="comment">// 触发熔断的条件类型：0 表示基于慢调用比例；1 表示基于异常比例。</span></span><br><span class="line">    <span class="attr">&quot;minRequestAmount&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="comment">// 在统计时间窗口内，至少需要多少个请求才会触发熔断判断。</span></span><br><span class="line">    <span class="attr">&quot;statIntervalMs&quot;</span><span class="punctuation">:</span> <span class="number">20000</span><span class="punctuation">,</span> <span class="comment">// 统计时间窗口的长度，单位为毫秒，默认20秒。</span></span><br><span class="line">    <span class="attr">&quot;slowRatioThreshold&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span><span class="punctuation">,</span> <span class="comment">// 慢调用比例阈值，仅在 grade 为 0 时有效。</span></span><br><span class="line">    <span class="attr">&quot;maxAllowedRt&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span> <span class="comment">// 最大允许响应时间，单位为毫秒，仅在 grade 为 0 时有效。</span></span><br><span class="line">    <span class="attr">&quot;timeWindow&quot;</span><span class="punctuation">:</span> <span class="number">10</span> <span class="comment">// 熔断后持续的时间，单位为秒。</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h5 id="3-热点参数规则（Param-Flow-Rule）"><a href="#3-热点参数规则（Param-Flow-Rule）" class="headerlink" title="3. 热点参数规则（Param Flow Rule）"></a>3. 热点参数规则（Param Flow Rule）</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yourResourceName&quot;</span><span class="punctuation">,</span> <span class="comment">// 资源名称，通常是你要保护的接口或方法的名字。</span></span><br><span class="line">    <span class="attr">&quot;paramIdx&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="comment">// 参数索引，指定对哪个参数进行热点参数限流。</span></span><br><span class="line">    <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="comment">// 限流阈值，表示允许的最大 QPS 或并发线程数。</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="comment">// 限流类型：0 表示基于并发线程数的限流；1 表示基于 QPS 的限流。</span></span><br><span class="line">    <span class="attr">&quot;durationInSec&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="comment">// 统计时间窗口的长度，单位为秒。</span></span><br><span class="line">    <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span> <span class="number">0</span> <span class="comment">// 流控效果：0 表示快速失败，直接拒绝超过阈值的请求；1 表示 Warm Up 模式；2 表示匀速排队模式。</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h5 id="4-授权规则（Authority-Rule）"><a href="#4-授权规则（Authority-Rule）" class="headerlink" title="4. 授权规则（Authority Rule）"></a>4. 授权规则（Authority Rule）</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yourResourceName&quot;</span><span class="punctuation">,</span> <span class="comment">// 资源名称，通常是你要保护的接口或方法的名字。</span></span><br><span class="line">    <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;appA,appB&quot;</span><span class="punctuation">,</span> <span class="comment">// 应用名称，用于标识哪些应用受到该规则的影响。多个应用名称用逗号分隔。</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="number">0</span> <span class="comment">// 授权策略：0 表示白名单策略；1 表示黑名单策略。</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yourResourceName&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;appC&quot;</span><span class="punctuation">,</span> <span class="comment">// 黑名单应用</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="number">1</span> <span class="comment">// 授权策略：1 表示黑名单策略。</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h5 id="5-系统规则（System-Rule）"><a href="#5-系统规则（System-Rule）" class="headerlink" title="5. 系统规则（System Rule）"></a>5. 系统规则（System Rule）</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;highestSystemLoad&quot;</span><span class="punctuation">:</span> <span class="number">32.0</span><span class="punctuation">,</span> <span class="comment">// 最高系统负载阈值。</span></span><br><span class="line">    <span class="attr">&quot;highestCpuUsage&quot;</span><span class="punctuation">:</span> <span class="number">0.8</span><span class="punctuation">,</span> <span class="comment">// 最高 CPU 使用率阈值。</span></span><br><span class="line">    <span class="attr">&quot;qps&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span> <span class="comment">// 系统级别的 QPS 阈值。</span></span><br><span class="line">    <span class="attr">&quot;threadCount&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span> <span class="comment">// 系统级别的并发线程数阈值。</span></span><br><span class="line">    <span class="attr">&quot;avgRt&quot;</span><span class="punctuation">:</span> <span class="number">50</span> <span class="comment">// 平均响应时间阈值，单位为毫秒。</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>



<h3 id="OpenFeign整合实现fallback服务降级"><a href="#OpenFeign整合实现fallback服务降级" class="headerlink" title="OpenFeign整合实现fallback服务降级"></a>OpenFeign整合实现fallback服务降级</h3><p>在原本的程序中，无论使用 [1] 还是 [2] 进行服务降级处理，都要针对每个接口在注解中声明其的服务降级方法，现在可以在类中说明即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】 CircuitBreaker方案</span></span><br><span class="line"><span class="meta">@RateLimiter(name = &quot;cloud-payment-service&quot;,fallbackMethod = &quot;myRateLimitFallback&quot;)</span>  </span><br><span class="line"><span class="comment">//【2】 Sentinel方案</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;dealHandler_testHotKey&quot;)</span></span><br></pre></td></tr></table></figure>

<h4 id="在服务提供者模块引入sentinel并开启支持"><a href="#在服务提供者模块引入sentinel并开启支持" class="headerlink" title="在服务提供者模块引入sentinel并开启支持"></a>在服务提供者模块引入sentinel并开启支持</h4><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置开启sentinel</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment">#配置Sentinel dashboard控制台服务地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br></pre></td></tr></table></figure>

<p>编写接口时无需再指定fallback，由 统一指定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/pay/nacos/get/&#123;orderNo&#125;&quot;)</span></span><br><span class="line"><span class="comment">// 无需再指定fallback，由 统一指定</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;getPayByOrderNo&quot;,blockHandler = &quot;handlerBlockHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultData <span class="title function_">getPayByOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;orderNo&quot;)</span> String orderNo)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//模拟从数据库查询出数据并赋值给DTO</span></span><br><span class="line">    <span class="type">PayDTO</span> <span class="variable">payDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayDTO</span>();</span><br><span class="line">    payDTO.setId(<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">return</span> ResultData.success(<span class="string">&quot;查询返回值：&quot;</span>+payDTO);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> ResultData <span class="title function_">handlerBlockHandler</span><span class="params">(<span class="meta">@PathVariable(&quot;orderNo&quot;)</span> String orderNo, BlockException exception)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ResultData.fail(ReturnCodeEnum.RC500.getCode(),<span class="string">&quot;getPayByOrderNo服务不可用，&quot;</span> +</span><br><span class="line">            <span class="string">&quot;触发sentinel流控配置规则&quot;</span>+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;o(╥﹏╥)o&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="API工具模块引入sentinel并统一指定服务降级处理方法"><a href="#API工具模块引入sentinel并统一指定服务降级处理方法" class="headerlink" title="API工具模块引入sentinel并统一指定服务降级处理方法"></a>API工具模块引入sentinel并统一指定服务降级处理方法</h4><p>引入sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--alibaba-sentinel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> 在对外暴露方法的接口处，使用<code>@FeignClient</code>注解参数<code>fallback</code>直接统一指定服务降级处理方法所在类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;nacos-payment-provider&quot;,fallback = PayFeignSentinelApiFallBack.class)</span></span><br></pre></td></tr></table></figure>

<p>新建服务降级处理类及方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayFeignSentinelApiFallBack</span> <span class="keyword">implements</span> <span class="title class_">PayFeignSentinelApi</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResultData <span class="title function_">getPayByOrderNo</span><span class="params">(String orderNo)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ResultData.fail(ReturnCodeEnum.RC500.getCode(),<span class="string">&quot;对方服务宕机或不可用，FallBack服务降级o(╥﹏╥)o&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务调用者引入sentinel并激活Sentinel对Feign的支持"><a href="#服务调用者引入sentinel并激活Sentinel对Feign的支持" class="headerlink" title="服务调用者引入sentinel并激活Sentinel对Feign的支持"></a>服务调用者引入sentinel并激活Sentinel<strong>对</strong>Feign的支持</h4><p>同样引入依赖，编写配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 激活Sentinel对Feign的支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>本节中springboot、springcloud、springcloudalibaba版本对应如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        &lt;spring.boot.version&gt;3.2.0&lt;/spring.boot.version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;spring.cloud.version&gt;2023.0.0&lt;/spring.cloud.version&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>3.0.9<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.cloud.version</span>&gt;</span>2022.0.2<span class="tag">&lt;/<span class="name">spring.cloud.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.cloud.alibaba.version</span>&gt;</span>2022.0.0.0-RC2<span class="tag">&lt;/<span class="name">spring.cloud.alibaba.version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>仅对本节如此，学完后恢复</p>
<h3 id="Gateway整合实现服务限流"><a href="#Gateway整合实现服务限流" class="headerlink" title="Gateway整合实现服务限流"></a>Gateway整合实现服务限流</h3><p>结合 Spring Cloud Gateway 和 Sentinel，可以在网关层面对所有请求进行统一的流量控制和限流，而不需要在每个微服务中单独配置。</p>
<p><a target="_blank" rel="noopener" href="http://sentinelguard.io/zh-cn/docs/api-gateway-flow-control.html">官方指导</a></p>
<p>网关模块引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-transport-simple-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-spring-cloud-gateway-adapter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>编写配置类</strong></p>
<p>其他环节直接复制，<code>doInit()</code>方法内的<code>initBlockHandler();</code>需要自己编写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GatewayConfiguration</span><span class="params">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);</span><br><span class="line">        <span class="built_in">this</span>.serverCodecConfigurer = serverCodecConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line">    <span class="keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="title function_">sentinelGatewayBlockExceptionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Register the block exception handler for Spring Cloud Gateway.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SentinelGatewayBlockExceptionHandler</span>(viewResolvers, serverCodecConfigurer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order(-1)</span></span><br><span class="line">    <span class="keyword">public</span> GlobalFilter <span class="title function_">sentinelGatewayFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SentinelGatewayFilter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化方法，在依赖注入完成后自动调用。</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 使用&#123;<span class="doctag">@link</span> javax.annotation.PostConstruct&#125;注解标记该方法，</span></span><br><span class="line"><span class="comment">     * 以确保在Spring容器完成依赖注入后执行初始化操作。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span> <span class="comment">// javax.annotation.PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doInit</span><span class="params">()</span> &#123;</span><br><span class="line">        initBlockHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化流量限制规则和处理程序。</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 设置限流规则，并定义自定义的异常处理器来返回特定的错误信息给客户端。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 处理/自定义返回的例外信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initBlockHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建并设置限流规则集合</span></span><br><span class="line">        Set&lt;GatewayFlowRule&gt; rules = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 添加限流规则：每秒最多允许2个请求到&quot;pay_routh1&quot;</span></span><br><span class="line">        rules.add(<span class="keyword">new</span> <span class="title class_">GatewayFlowRule</span>(<span class="string">&quot;pay_routh1&quot;</span>).setCount(<span class="number">2</span>).setIntervalSec(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">// 加载限流规则</span></span><br><span class="line">        GatewayRuleManager.loadRules(rules);</span><br><span class="line">        <span class="comment">// 定义自定义的限流处理器</span></span><br><span class="line">        <span class="type">BlockRequestHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockRequestHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">handleRequest</span><span class="params">(ServerWebExchange exchange, Throwable t)</span> &#123;</span><br><span class="line">                <span class="comment">// 创建响应数据</span></span><br><span class="line">                Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                <span class="comment">// 设置错误码和消息</span></span><br><span class="line">                map.put(<span class="string">&quot;errorCode&quot;</span>, HttpStatus.TOO_MANY_REQUESTS.getReasonPhrase());</span><br><span class="line">                map.put(<span class="string">&quot;errorMessage&quot;</span>, <span class="string">&quot;请求太过频繁，系统忙不过来，触发限流(sentinel+gataway整合Case)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 返回带有状态码和JSON内容类型的响应</span></span><br><span class="line">                <span class="keyword">return</span> ServerResponse.status(HttpStatus.TOO_MANY_REQUESTS)</span><br><span class="line">                        .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                        .body(BodyInserters.fromValue(map));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置全局的限流处理器</span></span><br><span class="line">        GatewayCallbackManager.setBlockHandler(handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这段代码的主要功能是：</p>
<ul>
<li>在Spring应用启动时，通过<code>@PostConstruct</code>注解的方法<code>doInit()</code>进行初始化操作。</li>
<li><code>initBlockHandler()</code>方法用于配置流量控制规则，并定义一个自定义的限流处理器。这个处理器会在请求超过设定的速率限制时被调用，向客户端返回适当的错误信息（如HTTP 429 Too Many Requests）。</li>
</ul>
<h2 id="Seata处理分布式事务"><a href="#Seata处理分布式事务" class="headerlink" title="Seata处理分布式事务"></a>Seata处理分布式事务</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p><a target="_blank" rel="noopener" href="https://seata.apache.org/zh-cn/">官网</a>		<a target="_blank" rel="noopener" href="https://github.com/apache/incubator-seata">源码</a>		<a target="_blank" rel="noopener" href="https://seata.apache.org/zh-cn/docs/ops/deploy-guide-beginner/">文档</a></p>
<p><strong>Seata</strong> (<code>simple extensiable autonomous transaction architecture</code>) 是一个开源的分布式事务解决方案，旨在解决微服务架构中的分布式事务问题。Seata 支持多种分布式事务模式，能够确保在跨多个服务或数据库的操作中保持数据的一致性和完整性。（在微服务项目中，不同的微服务可能对应不同的数据库（指的是存数据的库，即database，不是数据库的版本），而一个操作可能涉及到多个数据库，seata就是为了应对在微服务架构中跨多个数据库进行事务操作的需求而设计的。）</p>
<p>情景引入：</p>
<blockquote>
<p>一次业务操作需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题。但是，关系型数据库提供的能力是基于单机事务的，只能在本数据库（指的是存数据的库）内的操作事务，一旦遇到分布式事务场景，就需要通过更多其他技术手段来解决问题。</p>
<p>单体应用被拆分成微服务应用，原来的三个模块被拆分成三个独立的应用，分别使用三个独立的数据源，业务操作需要调用三个服务来完成。此时每个服务自己内部的数据一致性由本地事务来保证，但是全局的数据一致性问题没法保证。</p>
</blockquote>
<h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><p><a target="_blank" rel="noopener" href="https://seata.apache.org/zh-cn/download/seata-server">下载地址</a> 本笔记使用V2.0.0，下载解压即可。</p>
<h4 id="启动Seata服务（DB模式）"><a href="#启动Seata服务（DB模式）" class="headerlink" title="启动Seata服务（DB模式）"></a>启动Seata服务（DB模式）</h4><p>db模式为高可用模式，全局事务会话信息通过db共享，相应性能差些;</p>
<h5 id="步骤1：MySQL新建seata库，在其中建表global-table、branch-table、lock-table"><a href="#步骤1：MySQL新建seata库，在其中建表global-table、branch-table、lock-table" class="headerlink" title="步骤1：MySQL新建seata库，在其中建表global_table、branch_table、lock_table"></a><strong>步骤1：MySQL新建seata库，在其中建表global_table、branch_table、lock_table</strong></h5><p>请严格参照<a target="_blank" rel="noopener" href="https://github.com/apache/incubator-seata/blob/develop/script/server/db/mysql.sql">网址</a>的建表语法创建，建议直接复制。</p>
<h5 id="步骤2：修改配置文件"><a href="#步骤2：修改配置文件" class="headerlink" title="步骤2：修改配置文件"></a>步骤2：修改配置文件</h5><p>在安装目录-conf目录下修改<code>application.yaml</code>（建议先备份）需要修改：</p>
<ul>
<li><code>seata-config-type</code>：根据实际服务配置中心设置，本文修改为nacos。并在其下添加同级nacos说明</li>
<li><code>seata-registry-type</code>：根据实际服务注册中心设置，本文修改为nacos。并在其下添加同级nacos说明</li>
<li><code>seata-store-mode</code>：修改为db。并在其下添加同级db说明，根据实际情况编写</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># support: nacos, consul, apollo, zk, etcd3</span></span><br><span class="line">    <span class="comment"># type: file</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">namespace:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span> <span class="comment">#后续自己在nacos里面新建,不想新建SEATA_GROUP，就写DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></span><br><span class="line">    <span class="comment"># type: file</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span> <span class="comment">#后续自己在nacos里面新建,不想新建SEATA_GROUP，就写DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">namespace:</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span>    </span><br><span class="line">  <span class="attr">store:</span></span><br><span class="line">    <span class="comment"># support: file 、 db 、 redis 、 raft</span></span><br><span class="line">    <span class="comment"># mode: file</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">db:</span></span><br><span class="line">      <span class="attr">datasource:</span> <span class="string">druid</span></span><br><span class="line">      <span class="attr">db-type:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/seata?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT%2B8&amp;rewriteBatchedStatements=true&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">min-conn:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">max-conn:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">global-table:</span> <span class="string">global_table</span></span><br><span class="line">      <span class="attr">branch-table:</span> <span class="string">branch_table</span></span><br><span class="line">      <span class="attr">lock-table:</span> <span class="string">lock_table</span></span><br><span class="line">      <span class="attr">distributed-lock-table:</span> <span class="string">distributed_lock</span></span><br><span class="line">      <span class="attr">query-limit:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>



<p>其他模式请参考<code>application.example.yml</code></p>
<h5 id="启动运行并验证"><a href="#启动运行并验证" class="headerlink" title="启动运行并验证"></a>启动运行并验证</h5><p>在安装目录-bin下运行<code>seata-server.bat</code>。</p>
<p>验证：</p>
<ul>
<li>nacos管理页面可见服务。</li>
<li>seata运行管理页面<code>http://localhost:7091/</code>，账号密码均在前文yml中配置，默认均为seata</li>
</ul>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p><strong>三个组件：</strong></p>
<ul>
<li><code>TC (Transaction Coordinator) </code>：事务协调者（<code>seata</code>)，维护全局和分支事务的状态，驱动全局事务提交或回滚。</li>
<li><code>TM (Transaction Manager) </code>：事务管理器（标注了<code>@GlobalTransactional</code>的微服务模块，是事务的发起者），定义全局事务的范围，并根据TC维护的全局事务和分支事务状态，开始全局事务、提交或回滚全局事务。</li>
<li><code>RM (Resource Manager)</code> ：资源管理器（微服务中管理本地事务，即对数据库进行操作的组件），管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
<p>三个组件相互协作，TC以Seata 服务器(Server)形式独立部署，TM和RM则是以Seata Client的形式集成在微服务中运行，相当于项目组长TC-小组长TM-程序员RM</p>
<ol>
<li>TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID；</li>
<li>XID 在微服务调用链路的上下文中传播；</li>
<li>RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖；</li>
<li>TM 向 TC 发起针对 XID 的全局提交或回滚决议；</li>
<li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250306160752.png"></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>核心职责</th>
</tr>
</thead>
<tbody><tr>
<td><strong>TM</strong></td>
<td>定义全局事务边界，发起全局提交&#x2F;回滚，管理事务生命周期。</td>
</tr>
<tr>
<td><strong>TC</strong></td>
<td>协调全局事务状态，驱动分支事务的提交或回滚（决策者）。</td>
</tr>
<tr>
<td><strong>RM</strong></td>
<td>管理本地事务，生成&#x2F;删除 undo_log，执行 TC 的提交或回滚指令（执行者）。</td>
</tr>
</tbody></table>
<h4 id="AT模式工作流程示例"><a href="#AT模式工作流程示例" class="headerlink" title="AT模式工作流程示例"></a>AT模式工作流程示例</h4><p>以用户下单扣库存的分布式事务为例：</p>
<h5 id="1-全局事务开启（TM-发起）"><a href="#1-全局事务开启（TM-发起）" class="headerlink" title="1. 全局事务开启（TM 发起）"></a><strong>1. 全局事务开启（TM 发起）</strong></h5><ul>
<li><strong>场景</strong>：用户下单时，订单服务需要调用库存服务扣减库存，两者属于不同微服务（不同数据库）。</li>
<li><strong>TM（订单服务）</strong>：<ul>
<li>在业务方法上标注 <code>@GlobalTransactional</code>，<strong>开启全局事务</strong>。</li>
<li>向 <strong>TC（Seata Server）</strong> 发起请求，申请一个 <strong>全局事务ID（XID）</strong>。</li>
<li>将 XID 通过请求头（如 HTTP Header）传递给其他微服务（如库存服务）。</li>
</ul>
</li>
</ul>
<h5 id="2-分支事务注册与执行（RM-参与）"><a href="#2-分支事务注册与执行（RM-参与）" class="headerlink" title="2. 分支事务注册与执行（RM 参与）"></a><strong>2. 分支事务注册与执行（RM 参与）</strong></h5><ul>
<li><p><strong>订单服务（RM1）</strong>：</p>
<ul>
<li>执行本地 SQL（如插入订单表）。</li>
<li>在本地事务提交前，<strong>RM1 会拦截 SQL，生成 undo_log（回滚日志）</strong>，记录数据修改前的快照。</li>
<li><strong>向 TC 注册分支事务</strong>，关联全局 XID，告知 TC 自己属于该全局事务的一部分。</li>
<li><strong>提交本地事务</strong>（实际会先 hold 住，等待 TC 通知）。</li>
</ul>
</li>
<li><p><strong>库存服务（RM2）</strong>：</p>
<ul>
<li>收到订单服务的调用（携带 XID）。</li>
<li>执行本地 SQL（如扣减库存）。</li>
<li>同样生成 undo_log，<strong>向 TC 注册分支事务</strong>，关联同一个 XID。</li>
<li><strong>提交本地事务</strong>（同样先 hold 住）。</li>
</ul>
</li>
</ul>
<h5 id="3-全局事务提交-回滚（TC-协调）"><a href="#3-全局事务提交-回滚（TC-协调）" class="headerlink" title="3. 全局事务提交&#x2F;回滚（TC 协调）"></a><strong>3. 全局事务提交&#x2F;回滚（TC 协调）</strong></h5><ul>
<li><p><strong>TM（订单服务）</strong>：</p>
<ul>
<li>所有分支事务执行完毕后，TM 向 TC 发起 <strong>全局提交</strong> 或 <strong>全局回滚</strong> 请求。</li>
</ul>
</li>
<li><p><strong>TC（Seata Server）</strong>：</p>
<ul>
<li><strong>Phase 1（一阶段提交）</strong>：<ul>
<li>检查所有分支事务的本地事务是否已提交（通过分支事务状态）。</li>
<li>若所有分支事务成功，TC <strong>异步删除各 RM 的 undo_log</strong>，完成最终提交。</li>
</ul>
</li>
<li><strong>Phase 2（二阶段提交&#x2F;回滚）</strong>：<ul>
<li><strong>提交</strong>：TC 通知所有 RM 提交本地事务（实际是释放 hold 住的提交）。</li>
<li><strong>回滚</strong>：如果有分支事务失败，TC 通知所有 RM 根据 undo_log 回滚数据。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="异常场景处理"><a href="#异常场景处理" class="headerlink" title="异常场景处理"></a><strong>异常场景处理</strong></h5><ol>
<li><strong>某个分支事务失败</strong>：<ul>
<li>TC 收到失败状态后，通过 undo_log 回滚所有已提交的分支事务。</li>
</ul>
</li>
<li><strong>TC 宕机</strong>：<ul>
<li>Seata Server 高可用部署，通过集群保证 TC 的可用性。</li>
</ul>
</li>
<li><strong>网络中断</strong>：<ul>
<li>RM 会重试与 TC 的通信，直到事务状态最终一致。</li>
</ul>
</li>
</ol>
<h3 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h3><h4 id="必要步骤"><a href="#必要步骤" class="headerlink" title="必要步骤"></a>必要步骤</h4><p>【1】DB模式下，每个微服务对应的数据库都必须参照<a target="_blank" rel="noopener" href="https://github.com/apache/incubator-seata/blob/2.x/script/client/at/db/mysql.sql">网址</a>建表<code>undo_log</code></p>
<h4 id="微服务创建"><a href="#微服务创建" class="headerlink" title="微服务创建"></a>微服务创建</h4><p>仅说明与seata有关的操作</p>
<p>注意：为版本兼容，需要：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--仅为了整合openfeign + alibaba seata的案例，降低版本处理下--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>3.1.7<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring.cloud.version</span>&gt;</span>2022.0.4<span class="tag">&lt;/<span class="name">spring.cloud.version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>否则报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Name for argument of type [java.lang.Long] not specified, and parameter name information not found in class file either.</span><br></pre></td></tr></table></figure>



<h5 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="编写配置"><a href="#编写配置" class="headerlink" title="编写配置"></a>编写配置</h5><p><a target="_blank" rel="noopener" href="https://seata.apache.org/zh-cn/docs/user/configurations">参见</a></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">default_tx_group</span> <span class="comment"># 事务组，由它获得TC服务的集群名称</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span></span><br><span class="line">      <span class="attr">default_tx_group:</span> <span class="string">default</span> <span class="comment"># 事务组与TC服务集群的映射关系</span></span><br><span class="line">  <span class="attr">data-source-proxy-mode:</span> <span class="string">AT</span></span><br></pre></td></tr></table></figure>

<h5 id="数据库操作前使用GlobalTransactional注解"><a href="#数据库操作前使用GlobalTransactional注解" class="headerlink" title="数据库操作前使用GlobalTransactional注解"></a>数据库操作前使用<code>GlobalTransactional</code>注解</h5><p>Order微服务的service层方法，新增订单时需要扣减账户金额和库存，涉及到跨微服务跨数据库的事务操作（分布式事务）在操作的方法前添加<code>GlobalTransactional</code>注解。同时由于在一个微服务中可能有多个分布式事务，所以建议以<code>name</code>属性区分，并要求在出现异常时回滚<code>rollbackFor = Exception.class</code>(同<code>@Transactional</code>注解：</p>
<p><strong>建议一个分布式事务只操作3个以内的数据库，如果超过建议分成多个事务并用一个事务包裹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">    <span class="meta">@Resource</span><span class="comment">//订单微服务通过OpenFeign去调用库存微服务</span></span><br><span class="line">    <span class="keyword">private</span> StorageFeignApi storageFeignApi;</span><br><span class="line">    <span class="meta">@Resource</span><span class="comment">//订单微服务通过OpenFeign去调用账户微服务</span></span><br><span class="line">    <span class="keyword">private</span> AccountFeignApi accountFeignApi;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GlobalTransactional(name = &quot;zzyy-create-order&quot;,rollbackFor = Exception.class)</span> <span class="comment">//AT</span></span><br><span class="line">    <span class="comment">//@GlobalTransactional @Transactional(rollbackFor = Exception.class) //XA</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(Order order)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//xid检查</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 新建订单</span></span><br><span class="line">        log.info(<span class="string">&quot;==================&gt;开始新建订单&quot;</span>+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;xid_order:&quot;</span> +xid);</span><br><span class="line">        <span class="comment">//订单状态status：0：创建中；1：已完结</span></span><br><span class="line">        order.setStatus(<span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> orderMapper.insertSelective(order);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//插入订单成功后获得插入mysql的实体对象</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">orderFromDB</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(result &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            orderFromDB = orderMapper.selectOne(order);</span><br><span class="line">            <span class="comment">//orderFromDB = orderMapper.selectByPrimaryKey(order.getId());</span></span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; 新建订单成功，orderFromDB info: &quot;</span>+orderFromDB);</span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="comment">//2. 扣减库存</span></span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; 订单微服务开始调用Storage库存，做扣减count&quot;</span>);</span><br><span class="line">            storageFeignApi.decrease(orderFromDB.getProductId(), orderFromDB.getCount());</span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; 订单微服务结束调用Storage库存，做扣减完成&quot;</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="comment">//3. 扣减账号余额</span></span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; 订单微服务开始调用Account账号，做扣减money&quot;</span>);</span><br><span class="line">            accountFeignApi.decrease(orderFromDB.getUserId(), orderFromDB.getMoney());</span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; 订单微服务结束调用Account账号，做扣减完成&quot;</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="comment">//4. 修改订单状态</span></span><br><span class="line">            <span class="comment">//订单状态status：0：创建中；1：已完结</span></span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; 修改订单状态&quot;</span>);</span><br><span class="line">            orderFromDB.setStatus(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            Example whereCondition=<span class="keyword">new</span> <span class="title class_">Example</span>(Order.class);</span><br><span class="line">            Example.Criteria criteria=whereCondition.createCriteria();</span><br><span class="line">            criteria.andEqualTo(<span class="string">&quot;userId&quot;</span>,orderFromDB.getUserId());</span><br><span class="line">            criteria.andEqualTo(<span class="string">&quot;status&quot;</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">updateResult</span> <span class="operator">=</span> orderMapper.updateByExampleSelective(orderFromDB, whereCondition);</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; 修改订单状态完成&quot;</span>+<span class="string">&quot;\t&quot;</span>+updateResult);</span><br><span class="line">            log.info(<span class="string">&quot;-------&gt; orderFromDB info: &quot;</span>+orderFromDB);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        log.info(<span class="string">&quot;==================&gt;结束新建订单&quot;</span>+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;xid_order:&quot;</span> +xid);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><strong>AT 模式的核心思想</strong></p>
<p>AT（Auto Transaction）模式是 Seata 的默认模式，<strong>基于两阶段提交（2PC）优化</strong>，通过 <strong>自动生成反向 SQL（undo_log）</strong> 实现事务回滚，<strong>对业务代码几乎零侵入</strong>。<br>适用于大多数基于关系型数据库的分布式事务场景（如订单、库存、账户服务等）。</p>
<h4 id="AT-模式的工作流程（两阶段）"><a href="#AT-模式的工作流程（两阶段）" class="headerlink" title="AT 模式的工作流程（两阶段）"></a><strong>AT 模式的工作流程（两阶段）</strong></h4><h5 id="1-第一阶段（Phase-1）：执行本地事务并生成-undo-log"><a href="#1-第一阶段（Phase-1）：执行本地事务并生成-undo-log" class="headerlink" title="1. 第一阶段（Phase 1）：执行本地事务并生成 undo_log"></a><strong>1. 第一阶段（Phase 1）：执行本地事务并生成 undo_log</strong></h5><ul>
<li><strong>核心目标</strong>：每个分支事务执行本地操作，并记录数据快照（undo_log），<strong>提前提交本地事务</strong>（与传统 2PC 的“Prepare”阶段不同）。  </li>
<li><strong>具体步骤</strong>：  <ol>
<li><strong>SQL 解析与拦截</strong>：  <ul>
<li>RM 通过 Seata 的 <code>DataSourceProxy</code> 代理数据源，拦截业务 SQL（如 <code>INSERT/UPDATE/DELETE</code>）。</li>
</ul>
</li>
<li><strong>生成 undo_log</strong>：  <ul>
<li>解析 SQL 并生成 <strong>前置镜像（before image）</strong> 和 <strong>后置镜像（after image）</strong>，保存到 <code>undo_log</code> 表中。  </li>
<li>示例：  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 前置镜像（修改前的数据）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> product <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 后置镜像（修改后的数据）</span></span><br><span class="line"><span class="keyword">UPDATE</span> product <span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><strong>注册分支事务</strong>：  <ul>
<li>RM 向 TC（Seata Server）注册分支事务，绑定全局事务 ID（XID）。</li>
</ul>
</li>
<li><strong>提交本地事务</strong>：  <ul>
<li><strong>直接提交本地事务</strong>（将业务数据修改和 <code>undo_log</code> 写入数据库，保证原子性）。</li>
</ul>
</li>
<li><strong>释放本地锁，获取全局锁</strong>：  <ul>
<li>提交后释放本地数据库锁，但会通过 TC 获取 <strong>全局锁</strong>，防止其他事务脏写。</li>
</ul>
</li>
</ol>
</li>
</ul>
<h5 id="2-第二阶段（Phase-2）：全局提交或回滚"><a href="#2-第二阶段（Phase-2）：全局提交或回滚" class="headerlink" title="2. 第二阶段（Phase 2）：全局提交或回滚"></a><strong>2. 第二阶段（Phase 2）：全局提交或回滚</strong></h5><ul>
<li><p><strong>全局提交</strong>：  </p>
<ul>
<li>若所有分支事务成功，TC 通知各 RM <strong>异步删除 undo_log</strong>，释放全局锁。  </li>
<li>由于本地事务已提交，此阶段仅清理日志，效率极高。</li>
</ul>
</li>
<li><p><strong>全局回滚</strong>：  </p>
<ul>
<li>若任一分支事务失败，TC 通知各 RM <strong>根据 undo_log 回滚数据</strong>：  <ol>
<li>检查当前数据是否与 <strong>后置镜像</strong> 一致（确保未被其他事务修改）。  </li>
<li>若一致，执行反向 SQL（用前置镜像恢复数据）。  </li>
<li>删除 undo_log，释放全局锁。</li>
</ol>
</li>
<li><strong>回滚失败处理</strong>：若数据被其他事务修改（全局锁失效），需人工介入。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fushiye/BlogPicture/main/img_blog/20250306215146.png"></p>
<h4 id="AT-模式的核心机制"><a href="#AT-模式的核心机制" class="headerlink" title="AT 模式的核心机制"></a><strong>AT 模式的核心机制</strong></h4><h5 id="1-undo-log-机制"><a href="#1-undo-log-机制" class="headerlink" title="1. undo_log 机制"></a><strong>1. undo_log 机制</strong></h5><ul>
<li><strong>作用</strong>：记录数据修改前后的快照，用于回滚。  </li>
<li><strong>存储</strong>：每个参与事务的数据库中都有一个 <code>undo_log</code> 表，结构如下：  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> undo_log (</span><br><span class="line">  id <span class="type">BIGINT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">  branch_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  <span class="comment">-- 分支事务ID</span></span><br><span class="line">  xid <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,   <span class="comment">-- 全局事务ID</span></span><br><span class="line">  context <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  rollback_info LONGBLOB <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  <span class="comment">-- 回滚信息（前后镜像）</span></span><br><span class="line">  log_status <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,          <span class="comment">-- 状态（0-正常，1-已删除）</span></span><br><span class="line">  log_created <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  log_modified <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="2-全局锁机制"><a href="#2-全局锁机制" class="headerlink" title="2. 全局锁机制"></a><strong>2. 全局锁机制</strong></h5><ul>
<li><strong>目的</strong>：防止其他事务在全局事务未完成时修改相同数据（避免脏写）。  </li>
<li><strong>实现</strong>：  <ul>
<li>在 Phase 1，RM 向 TC 注册分支事务时，TC 会为涉及的数据行 <strong>注册全局锁</strong>。  </li>
<li>其他事务修改同一数据时，会尝试获取全局锁，若失败则阻塞或重试。</li>
</ul>
</li>
</ul>
<hr>
<h4 id="AT-模式-vs-传统-2PC"><a href="#AT-模式-vs-传统-2PC" class="headerlink" title="AT 模式 vs 传统 2PC"></a><strong>AT 模式 vs 传统 2PC</strong></h4><table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>AT 模式</strong></th>
<th><strong>传统 2PC</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>本地事务提交</strong></td>
<td>Phase 1 直接提交，无需长时间锁资源</td>
<td>Phase 1 仅预提交，资源需锁定到 Phase 2</td>
</tr>
<tr>
<td><strong>侵入性</strong></td>
<td>对业务代码无侵入</td>
<td>需手动编写 Prepare&#x2F;Commit&#x2F;Rollback</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>高（Phase 1 提前提交）</td>
<td>低（资源锁定时间长）</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>基于关系型数据库的简单分布式事务</td>
<td>强一致性要求极高的场景</td>
</tr>
</tbody></table>
<hr>
<h4 id="AT-模式的典型问题"><a href="#AT-模式的典型问题" class="headerlink" title="AT 模式的典型问题"></a><strong>AT 模式的典型问题</strong></h4><ol>
<li><p><strong>脏写问题</strong>：  </p>
<ul>
<li>若全局事务未提交时，其他事务绕过 Seata 直接修改数据（如手动执行 SQL），可能导致数据不一致。  </li>
<li><strong>解决方案</strong>：所有数据操作必须通过 Seata 的 <code>DataSourceProxy</code>。</li>
</ul>
</li>
<li><p><strong>回滚冲突</strong>：  </p>
<ul>
<li>回滚时发现数据已被其他事务修改（与后置镜像不一致），需人工处理。  </li>
<li><strong>优化方案</strong>：业务设计时减少长事务，或使用 TCC 模式。</li>
</ul>
</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a>
              <a href="/tags/SpringCloudAlibaba/" rel="tag"><i class="fa fa-tag"></i> SpringCloudAlibaba</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/02/18/Java-Cloud2-SpringCloud/" rel="prev" title="Java-Cloud2-SpringCloud">
                  <i class="fa fa-angle-left"></i> Java-Cloud2-SpringCloud
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/02/18/Container-Docker/" rel="next" title="Container-Docker">
                  Container-Docker <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  
  <div class="comments giscus-container">
  </div>
  
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Shearington</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">449k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">24:56</span>
  </span>
</div>
<!--
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"Fushiye/Fushiye.github.io","repo_id":"R_kgDOLyiTvA","category":"Announcements","category_id":"DIC_kwDOLyiTvM4CteAo","mapping":"title","strict":0,"reactions_enabled":1,"emit_metadata":0,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"top","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-strict'           : CONFIG.giscus.strict,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
